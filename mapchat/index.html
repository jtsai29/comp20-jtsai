<!DOCTYPE html>

<html>

<head>
	<title>Map Chat</title>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>
	<link rel="stylesheet" href="map_style.css" />
		
	<script>
		//Variables for my map display
		var myLat = 0;
		var myLong = 0;
		var myLoc = new google.maps.LatLng(myLat, myLong);
		var map;
		var marker;
		var infowindow = new google.maps.InfoWindow();
		var login = "LayneVasquez";
		var message = "I'm really feeling it!";
		
		//Variables for data sending/requesting
		var req = new XMLHttpRequest();
		var store_url = "https://secret-about-box.herokuapp.com/sendLocation";
		var myData = "login=" + login + "&lat=" + myLat + 
			"&lng=" + myLong + "&message=" + message;
		var parsedInfo;

		function init() {
			map = new google.maps.Map(document.getElementById("map_canvas"), {
				zoom: 14,
				center: myLoc
			});
			getMyLoc();
		}
		
		function getMyLoc() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(function(pos) {
					myLat = pos.coords.latitude;
					myLong = pos.coords.longitude;
					sendData();
					renderMap();
				});
			}
			else {
				alert("Geolocation is not supported by your web browser.");
			}
		}

		function sendData() {
			myData = "login=" + login + "&lat=" + myLat + 
				"&lng=" + myLong + "&message=" + message;
			req.open("POST", store_url, true);

			req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

			req.onreadystatechange = function() {
				if (req.readyState == 4 && req.status == 200) {
					parsedInfo = JSON.parse(req.responseText);
					renderMap(parsedInfo);
				}
			}

			req.send(myData);
		}

		function renderMap(parseData) {
			myLoc = new google.maps.LatLng(myLat, myLong);
			
			//Update map and go to my location
			map.panTo(myLoc);

			//Create my marker
			marker_url = "map_marker.png";
			marker = new google.maps.Marker({
				position: myLoc,
				title: login,
				icon: marker_url
			});
			marker.setMap(map);

			//Open info window on click of marker
			google.maps.event.addListener(marker, 'click', function() {
				infowindow.setContent(marker.title);
				infowindow.open(map, marker);
			});

			//Display other users on map
			var otherInfo = new google.maps.InfoWindow();
			for (i = 0; i < parseData.length; i++) {
				//Make marker
				user = parseData[i];

				/*Don't redisplay myself
				if (user["login"] == login) {
					continue;
				}*/

				userLoc = new google.maps.LatLng(user["lat"], user["lng"]);

				distance = 0;
				displayData = user["login"] + ", " + 
					user["message"] + ", " + distance + " miles";

				userMark = new google.maps.Marker({
					position: userLoc,
					title: displayData
				});
				userMark.setMap(map);

				//Set info window
				google.maps.event.addListener(userMark, 'click', function() {
					otherInfo.setContent(userMark.title);
					otherInfo.open(map, this);
				});
			}
		}
	</script>
</head>

<body onload="init()">
	<h1>Map Chat</h1>
	<div id="map_canvas"></div>
</body>

</html>
